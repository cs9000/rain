<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Outlook</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        .days {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            position: relative;
        }
        .day {
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .day1 {
            background: linear-gradient(135deg, #e6f0fa 0%, #d1e3f6 100%);
        }
        .day2 {
            background: linear-gradient(135deg, #e8f5e9 0%, #d4e8d9 100%);
        }
        .day3 {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0d4f2 100%);
        }
        .day h2 {
            margin-top: 0;
            color: #007bff;
        }
        .high {
            font-weight: bold;
            margin-bottom: 20px;
        }
        .period {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .period h3 {
            flex: 1;
            margin: 0;
            font-size: 1em;
        }
        .icon {
            font-size: 2em;
            margin-right: 10px;
        }
        .rain {
            font-size: 0.9em;
            color: #555;
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
        .error {
            text-align: center;
            color: #dc3545;
        }
        #debug {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #debug-toggle {
            display: block;
            margin: 20px auto;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            z-index: 10;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .loading .day {
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <h1>Weather Outlook</h1>
    <div id="error" class="error"></div>
    <div class="days" id="days">
        <div class="loader" id="loader"></div>
        <div class="day day1">
            <h2 id="day1_name">Today</h2>
            <p class="high">High: <span id="day1_high"></span>¬∞F</p>
            <div id="day1_morning" class="period">
                <h3>Morning</h3>
                <span id="day1_morning_icon" class="icon"></span>
                <span id="day1_morning_rain" class="rain"></span>
            </div>
            <div id="day1_afternoon" class="period">
                <h3>Afternoon</h3>
                <span id="day1_afternoon_icon" class="icon"></span>
                <span id="day1_afternoon_rain" class="rain"></span>
            </div>
            <div id="day1_evening" class="period">
                <h3>Evening</h3>
                <span id="day1_evening_icon" class="icon"></span>
                <span id="day1_evening_rain" class="rain"></span>
            </div>
        </div>
        <div class="day day2">
            <h2 id="day2_name">Tomorrow</h2>
            <p class="high">High: <span id="day2_high"></span>¬∞F</p>
            <div id="day2_morning" class="period">
                <h3>Morning</h3>
                <span id="day2_morning_icon" class="icon"></span>
                <span id="day2_morning_rain" class="rain"></span>
            </div>
            <div id="day2_afternoon" class="period">
                <h3>Afternoon</h3>
                <span id="day2_afternoon_icon" class="icon"></span>
                <span id="day2_afternoon_rain" class="rain"></span>
            </div>
            <div id="day2_evening" class="period">
                <h3>Evening</h3>
                <span id="day2_evening_icon" class="icon"></span>
                <span id="day2_evening_rain" class="rain"></span>
            </div>
        </div>
        <div class="day day3">
            <h2 id="day3_name">Day After</h2>
            <p class="high">High: <span id="day3_high"></span>¬∞F</p>
            <div id="day3_morning" class="period">
                <h3>Morning</h3>
                <span id="day3_morning_icon" class="icon"></span>
                <span id="day3_morning_rain" class="rain"></span>
            </div>
            <div id="day3_afternoon" class="period">
                <h3>Afternoon</h3>
                <span id="day3_afternoon_icon" class="icon"></span>
                <span id="day3_afternoon_rain" class="rain"></span>
            </div>
            <div id="day3_evening" class="period">
                <h3>Evening</h3>
                <span id="day3_evening_icon" class="icon"></span>
                <span id="day3_evening_rain" class="rain"></span>
            </div>
        </div>
    </div>
    <button id="debug-toggle">See Details</button>
    <div id="debug" class="hidden"></div>

    <script>
        function formatDate(date) {
            return date.toISOString().slice(0, 10);
        }

        function getDayName(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleString('en-US', { timeZone: 'America/New_York', weekday: 'long' });
        }

        function processPeriod(indices, precip, pop, conditions, prefix) {
            const periodDiv = document.getElementById(prefix);
            const iconEl = document.getElementById(prefix + '_icon');
            const rainEl = document.getElementById(prefix + '_rain');

            if (indices.length === 0) {
                periodDiv.classList.add('hidden');
                return;
            }

            let totalPrecip = 0;
            let maxPop = 0;
            let hasRainText = false;
            indices.forEach(i => {
                totalPrecip += precip[i] || 0;
                if (pop[i] > maxPop) maxPop = pop[i] || 0;
                const conditionText = conditions[i]?.text?.toLowerCase() || '';
                if (conditionText.includes('rain') || conditionText.includes('shower') || 
                    conditionText.includes('thunder') || conditionText.includes('drizzle')) {
                    hasRainText = true;
                }
            });

            const isRainy = hasRainText || maxPop >= 10 || totalPrecip >= 0.001;
            iconEl.textContent = isRainy ? 'üåßÔ∏è' : '‚òÄÔ∏è';
            if (isRainy) {
                rainEl.textContent = `${maxPop}% chance, ${totalPrecip.toFixed(2)} in`;
            } else {
                rainEl.textContent = '';
            }
            periodDiv.classList.remove('hidden');
        }

        function loadWeather() {
            const API_KEY = '7b2406496cd94d9f8ad151853252208'; // Provided WeatherAPI key
            const lat = 27.7125; // Wimauma, FL
            const lon = -82.2987;
            const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${lat},${lon}&days=3&aqi=no&alerts=no`;

            // Show loader
            const daysEl = document.getElementById('days');
            const loaderEl = document.getElementById('loader');
            daysEl.classList.add('loading');

            // Add timeout to fetch request
            const fetchWithTimeout = (url, options, timeout = 10000) => {
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Fetch timeout')), timeout)
                    )
                ]);
            };

            fetchWithTimeout(url)
                .then(res => {
                    if (!res.ok) {
                        console.error('Fetch error:', res.status, res.statusText);
                        throw new Error(`API request failed: ${res.status} ${res.statusText}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Raw API response:', data);
                    if (!data.forecast || !data.forecast.forecastday || !data.location || !data.location.localtime) {
                        console.error('Invalid API response structure:', data);
                        throw new Error('Invalid API response structure');
                    }

                    // Hide loader
                    daysEl.classList.remove('loading');
                    loaderEl.classList.add('hidden');

                    const daysData = data.forecast.forecastday;
                    console.log('API daysData:', daysData.map(d => d.date));
                    if (!daysData || daysData.length < 3) {
                        document.getElementById('error').textContent = 'Insufficient forecast data from API';
                        console.error('API returned insufficient days:', daysData);
                        return;
                    }

                    const localtime = new Date(data.location.localtime);
                    const currentHour = localtime.getHours();
                    const currentDayStr = formatDate(localtime);
                    console.log('Current date:', currentDayStr, 'Current hour:', currentHour, 'Localtime:', data.location.localtime);

                    // Debug day names
                    console.log('Parsed day names:', {
                        day1: getDayName(daysData[0]?.date),
                        day2: getDayName(daysData[1]?.date),
                        day3: getDayName(daysData[2]?.date)
                    });

                    const days = [
                        { date: daysData[0]?.date, prefix: 'day1', index: 0, name: 'Today' },
                        { date: daysData[1]?.date, prefix: 'day2', index: 1, name: 'Tomorrow' },
                        { date: daysData[2]?.date, prefix: 'day3', index: 2, name: getDayName(daysData[2]?.date) }
                    ];
                    console.log('Days array:', days.map(d => ({ name: d.name, date: d.date })));

                    let debugInfo = '<h3>Raw API Data</h3>';
                    daysData.forEach((day, idx) => {
                        const dayName = idx === 0 ? 'Today' : idx === 1 ? 'Tomorrow' : getDayName(day.date);
                        debugInfo += `<p><strong>${dayName} (${day.date})</strong></p>`;
                        debugInfo += `<p>Max Temp: ${day.day.maxtemp_f}¬∞F</p>`;
                        debugInfo += '<ul>';
                        day.hour.forEach(h => {
                            debugInfo += `<li>${h.time}: ${h.chance_of_rain}% rain, ${h.precip_in} in, Condition: ${h.condition.text}</li>`;
                        });
                        debugInfo += '</ul>';
                    });

                    days.forEach(day => {
                        const dayData = daysData[day.index];
                        if (!dayData) {
                            document.getElementById('error').textContent = `No data for ${day.date}`;
                            return;
                        }

                        // Set day names and highs
                        document.getElementById(`${day.prefix}_name`).textContent = day.name;
                        const highTemp = dayData.day.maxtemp_f;
                        document.getElementById(`${day.prefix}_high`).textContent = isNaN(highTemp) ? 'N/A' : Math.round(highTemp);

                        const hourly = dayData.hour;
                        let morningIdx = [];
                        let afternoonIdx = [];
                        let eveningIdx = [];

                        // Debug indices for each period
                        debugInfo += `<p><strong>Indices for ${day.name} (${day.date})</strong></p>`;
                        hourly.forEach((h, i) => {
                            const hourTime = new Date(h.time + ' EDT'); // Explicitly set EDT
                            const hourDateStr = formatDate(hourTime);
                            const hour = hourTime.getHours();
                            console.log(`Hour ${i}: rawTime=${h.time}, parsedTime=${hourTime}, hour=${hour}, date=${hourDateStr}, matches day=${day.date}`);
                            if (hourDateStr === day.date) {
                                if (day.index === 0 && hour < currentHour) {
                                    console.log(`Skipping hour ${hour} for today (before currentHour ${currentHour})`);
                                    return; // Skip past hours on current day
                                }
                                if (hour >= 6 && hour < 12) {
                                    morningIdx.push(i);
                                } else if (hour >= 12 && hour < 18) {
                                    afternoonIdx.push(i);
                                } else if (hour >= 18 && hour <= 23) {
                                    eveningIdx.push(i);
                                }
                            } else {
                                console.log(`Hour ${i} date mismatch: hourDateStr=${hourDateStr}, day.date=${day.date}`);
                            }
                        });

                        // Fallback for today's evening if empty
                        if (day.index === 0 && eveningIdx.length === 0 && currentHour >= 18) {
                            console.log(`Forcing evening indices for today: [${hourly.findIndex(h => h.time.includes('22:00'))}, ${hourly.findIndex(h => h.time.includes('23:00'))}]`);
                            eveningIdx = [
                                hourly.findIndex(h => h.time.includes('22:00')),
                                hourly.findIndex(h => h.time.includes('23:00'))
                            ].filter(i => i !== -1);
                        }

                        console.log(`Indices for ${day.name}: Morning=[${morningIdx}], Afternoon=[${afternoonIdx}], Evening=[${eveningIdx}]`);
                        debugInfo += `<p>Morning Indices: [${morningIdx.join(', ')}]</p>`;
                        debugInfo += `<p>Afternoon Indices: [${afternoonIdx.join(', ')}]</p>`;
                        debugInfo += `<p>Evening Indices: [${eveningIdx.join(', ')}]</p>`;

                        const precip = hourly.map(h => h.precip_in);
                        const pop = hourly.map(h => h.chance_of_rain);
                        const conditions = hourly.map(h => h.condition);

                        processPeriod(morningIdx, precip, pop, conditions, `${day.prefix}_morning`);
                        processPeriod(afternoonIdx, precip, pop, conditions, `${day.prefix}_afternoon`);
                        processPeriod(eveningIdx, precip, pop, conditions, `${day.prefix}_evening`);
                    });

                    document.getElementById('debug').innerHTML = debugInfo;
                })
                .catch(err => {
                    // Hide loader on error
                    daysEl.classList.remove('loading');
                    loaderEl.classList.add('hidden');
                    console.error('Fetch error:', err);
                    document.getElementById('error').textContent = `Failed to load weather data: ${err.message}. Please try again later.`;
                });
        }

        // Toggle debug info
        document.getElementById('debug-toggle').addEventListener('click', () => {
            const debug = document.getElementById('debug');
            debug.classList.toggle('hidden');
            document.getElementById('debug-toggle').textContent = debug.classList.contains('hidden') ? 'See Details' : 'Hide Details';
        });

        // Load weather for Wimauma, FL immediately
        loadWeather();
    </script>
</body>
</html>